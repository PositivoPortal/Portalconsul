<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Portal Técnico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 40px 20px;
      color: #fff;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.05);
      padding: 30px;
      border-radius: 16px;
      width: 100%;
      max-width: 520px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }
    h2 { text-align: center; margin: 0 0 8px; }
    .sub { text-align: center; margin: 0 0 24px; opacity: .85; font-weight: 500; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    select, input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.12);
      color: #fff;
      font-size: 1em;
      outline: 1px solid rgba(255,255,255,0.15);
    }
    /* Loader simples */
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 18px 0 10px 0;
    }
    .loader-dot {
      width: 10px;
      height: 10px;
      margin: 0 4px;
      border-radius: 50%;
      background: #00aaff;
      opacity: 0.7;
      animation: loader-bounce 1s infinite alternate;
    }
    .loader-dot:nth-child(2) { animation-delay: 0.2s; }
    .loader-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes loader-bounce {
      to { opacity: 1; transform: translateY(-8px); }
    }
    input::placeholder { color: #ccc; }
    select option { color: #111; }
    button {
      width: 100%;
      margin-top: 18px;
      padding: 12px;
      background-color: #00aaff;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: filter .2s ease;
    }
    button:hover { filter: brightness(0.92); }
    button:disabled {
      background-color: #0077aa;
      cursor: not-allowed;
      filter: brightness(0.7);
    }
    #dataHora {
      text-align: center;
      margin-top: 14px;
      font-size: 0.92em;
      color: #cfcfcf;
    }
    #infoProgramacao {
      margin-top: 24px;
      padding: 15px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 8px;
      display: none;
    }
    #infoProgramacao a {
      display: block;
      margin-top: 10px;
      color: #00aaff;
      text-align: center;
      text-decoration: underline;
      word-break: break-all;
    }
    .copy-button {
      display: block;
      width: 100%;
      background-color: #00aaff;
      border: none;
      color: #fff;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 600;
    }
    .copy-button:hover { filter: brightness(0.92); }
    textarea.preview {
      width: 100%;
      height: 120px;
      margin-top: 12px;
      padding: 10px;
      border-radius: 6px;
      resize: none;
      background-color: rgba(255,255,255,0.1);
      color: #fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.95em;
      border: none;
      outline: 1px solid rgba(255,255,255,0.15);
    }
    .muted { color: #bbb; text-align: center; margin-top: 10px; }
    @media (max-width: 500px) {
      .container { padding: 20px; }
    }
    .mb-3 { margin-bottom: 25px; }
  </style>
</head>
<body onload="iniciarRelogio()">
  <div class="container">
    <h2>Consulta de Programação</h2>
    <p class="sub">POSITIVO TECNOLOGIA</p>

    <div class="mb-3">
      <label for="torre">Torre de Atendimento:</label>
      <select id="torre" onchange="atualizarTecnicos()" aria-label="Torre de Atendimento">
        <option value="">Selecione a torre</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="tecnico">Técnico:</label>
      <select id="tecnico" aria-label="Técnico">
        <option value="">Selecione o técnico</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="senha">Senha:</label>
      <input type="password" id="senha" placeholder="Digite sua senha" aria-label="Senha" />
    </div>

    <div id="dataHora" aria-live="polite">Data/Hora atual:</div>

    <button id="btnConsultar" class="mb-3" onclick="consultarInfo()" disabled>Consultar Programação</button>

    <div id="infoProgramacao"></div>
  <p class="muted">Dica: selecione a torre, escolha o técnico, informe a senha e clique em “Consultar”.</p>
  </div>

  <script>

    // --- Funções para buscar dados dinâmicos da API ---
    const API_BASE = "https://6028976d8fe6e979b6d4ed0db4e8dc.e9.environment.api.powerplatform.com";
    const API_KEY = "XeiDxZXC5vcqAlPQY9eBcIJQU3Dst3rm8xCqLyDsoKBWvS8vca56YRz8WLmbzmFxWouQvxCy6Zkyjx3QG1wXtYJZ9kHuERhLg6QVTHJ9zlfaYvkDSe34m4bdQkayyvTh";

    async function carregarTorresETecnicos() {
      const torreSelect = document.getElementById("torre");
      // Mostra loader visual
      let loaderDiv = document.getElementById('loader-torres');
      if (!loaderDiv) {
        loaderDiv = document.createElement('div');
        loaderDiv.id = 'loader-torres';
        loaderDiv.className = 'loader';
        loaderDiv.innerHTML = '<div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div>';
        torreSelect.parentElement.insertBefore(loaderDiv, torreSelect);
      }
      loaderDiv.style.display = 'flex';
      torreSelect.disabled = true;
      torreSelect.innerHTML = '<option value="">Carregando torres...</option>';
      try {
        const url = `${API_BASE}/powerautomate/automations/direct/workflows/e8626ead9df342dcb5d21c17fc650b54/triggers/manual/paths/invoke/geo_dispatch/torres?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=tngVQdZR2qrKGvWE6QSYoCZAttcydlDW2EFh0cKPBBQ`;
        const resp = await fetch(url, {
          headers: { "x-api-key": API_KEY }
        });
        if (!resp.ok) throw new Error("Erro ao buscar torres");
        const data = await resp.json();
        window._torres = data;
        if (!Array.isArray(data) || data.length === 0) {
          torreSelect.innerHTML = '<option value="">Nenhuma torre encontrada</option>';
        } else {
          torreSelect.innerHTML = '<option value="">Selecione a torre</option>' +
            data.map(torre => `<option value="${torre.id}">${torre.nome}</option>`).join("");
        }
      } catch (e) {
        torreSelect.innerHTML = `<option value="">Erro ao carregar torres: ${e.message}</option>`;
      }
      loaderDiv.style.display = 'none';
      torreSelect.disabled = false;
      atualizarTecnicos();
    }

    function atualizarTecnicos() {
      const torreId = document.getElementById("torre").value;
      const tecnicoSelect = document.getElementById("tecnico");
      const infoDiv = document.getElementById("infoProgramacao");
      tecnicoSelect.innerHTML = '<option value="">Carregando técnicos...</option>';
      infoDiv.style.display = "none";
      if (!window._torres) {
        tecnicoSelect.innerHTML = '<option value="">Selecione a torre</option>';
        return;
      }
      const torre = window._torres.find(t => t.id === torreId);
      if (torre && Array.isArray(torre.tecnicos) && torre.tecnicos.length > 0) {
        tecnicoSelect.innerHTML = '<option value="">Selecione o técnico</option>' +
          torre.tecnicos.map(tecnico => `<option value="${tecnico.id}">${tecnico.nome}</option>`).join("");
      } else {
        tecnicoSelect.innerHTML = '<option value="">Nenhum técnico encontrado</option>';
      }
    }



    function iniciarRelogio() {
      const el = document.getElementById("dataHora");
      const tick = () => {
        const d = new Date();
        el.textContent = `Data/Hora atual: ${d.toLocaleString('pt-BR')}`;
      };
      tick();
      setInterval(tick, 1000);
    }

    function isValidHttpUrl(value) {
      try {
        const url = new URL(value);
        return url.protocol === "http:" || url.protocol === "https:";
      } catch {
        return false;
      }
    }

    async function consultarInfo() {
      const torreId = document.getElementById("torre").value;
      const tecnicoId = document.getElementById("tecnico").value;
      const senha = document.getElementById("senha").value;
      const infoDiv = document.getElementById("infoProgramacao");
      infoDiv.style.display = "none";
      infoDiv.innerHTML = '';

      if (!torreId) { alert("Selecione a torre."); return; }
      if (!tecnicoId) { alert("Selecione o técnico."); return; }
      if (!senha) { alert("Digite a senha."); return; }

      let tecnicoNome = tecnicoId;
      if (window._torres) {
        const torre = window._torres.find(t => t.id === torreId);
        if (torre && torre.tecnicos) {
          const tec = torre.tecnicos.find(t => t.id === tecnicoId);
          if (tec) tecnicoNome = tec.nome;
        }
      }

      infoDiv.innerHTML = '<div class="muted">Consultando programação...</div>';
      infoDiv.style.display = "block";

      try {
        const url = `${API_BASE}/powerautomate/automations/direct/workflows/2d3f9f4e800e42f5881b573a655c3cb6/triggers/manual/paths/invoke/geo_dispatch/rotas?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ERTbsWnaM5ft_h9zFu0kY4qjsfPAqGnIirmlCt6jbUU`;
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': API_KEY
          },
          body: JSON.stringify({
            torreId: torreId,
            tecnicoId: tecnicoId,
            secret: senha
          })
        });

        if (!resp.ok) {
          let msg = "Erro ao consultar programação";
          if (resp.status === 401) {
            msg = "Usuário inativado ou senha incorreta.";
          } else if (resp.status === 404) {
            msg = "Não há rotas planejadas para o técnico.";
          }
          infoDiv.innerHTML = `<div class="muted">${msg}</div>`;
          infoDiv.style.display = "block";
          return;
        }

        const data = await resp.json();
        const info = data.chamados ?? JSON.stringify(data, null, 2);
        const link = data.rotas ?? '';
        const linkHtml = isValidHttpUrl(link)
          ? `<a href="${link}" target="_blank" rel="noopener noreferrer">Abrir rota no Google Maps</a>`
          : `<div class="muted">Sem programação de rota.</div>`;
        infoDiv.innerHTML = `
          <div class="muted">${tecnicoNome}</div>
          <button class="copy-button" onclick="copiarInfo()">Copiar lista de ocorrências</button>
          <textarea class="preview" id="textoInfo" readonly>${info}</textarea>
          ${linkHtml}
        `;
      } catch (e) {
        infoDiv.innerHTML = `<div class="muted">Erro ao consultar programação: ${e.message}</div>`;
      }
      infoDiv.style.display = "block";
    }

    function copiarInfo() {
      const texto = document.getElementById("textoInfo")?.value ?? "";
      navigator.clipboard.writeText(texto)
        .then(() => alert("Informações copiadas com sucesso!"))
        .catch(() => alert("Não foi possível copiar. Verifique permissões do navegador."));
    }

    function checarCamposPreenchidos() {
      const torre = document.getElementById('torre').value;
      const tecnico = document.getElementById('tecnico').value;
      const senha = document.getElementById('senha').value;
      const btn = document.getElementById('btnConsultar');
      btn.disabled = !(torre && tecnico && senha);
    }


    // Carregar torres e técnicos ao iniciar
    window.addEventListener('DOMContentLoaded', () => {
      carregarTorresETecnicos();
      checarCamposPreenchidos();
    });
    document.getElementById('torre').addEventListener('change', () => {
      atualizarTecnicos();
      checarCamposPreenchidos();
    });
    document.getElementById('tecnico').addEventListener('change', checarCamposPreenchidos);
    document.getElementById('senha').addEventListener('input', checarCamposPreenchidos);
    document.getElementById('senha').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') consultarInfo();
    });
  </script>
</body>
</html>

